# 智能提示词工程师系统 - 问题列表

**版本**: 0.1.0  
**日期**: 2025-10-05  
**状态**: 待修复

## 概述

本文档记录了智能提示词工程师系统在测试过程中发现的主要问题，包括用户反馈的问题和代码分析中发现的问题。这些问题按优先级和影响范围分类，为后续的修复工作提供指导。

## 高优先级问题

### 1. 聊天输出缺少终止按钮

**问题描述**: 当AI生成内容过长或出现错误时，用户无法主动停止输出，只能等待完成。

**影响范围**: 用户体验严重受影响

**相关文件**:
- `packages/ui/src/components/MessageItem.vue` (第28-44行)
- `packages/web/src/AppContent.vue` (第232-300行)

**问题分析**:
```vue
<!-- MessageItem.vue 中缺少停止按钮 -->
<template v-if="message.streaming">
  <div v-if="message.thinkingProcess" class="thinking-block">
    <div class="thinking-title">思考过程</div>
    <div class="thinking-content" v-html="renderMarkdown(message.thinkingProcess)" />
  </div>
  <div v-if="message.content" class="message-text" v-html="renderMarkdown(message.content)" />
</template>
```

**修复建议**:
1. 在流式输出时添加停止按钮
2. 实现流式请求的取消机制
3. 在LLMService中添加abortController支持

**代码位置**:
- 需要在`MessageItem.vue`中添加停止按钮
- 需要在`LLMService.chatStream`方法中支持取消操作
- 需要在`AppContent.vue`中处理停止事件

### 2. 测试模式功能失效

**问题描述**: 切换到"自由聊天模式"后，发送消息仍然会触发Agent路由系统，而不是直接调用LLM。

**影响范围**: 核心功能失效

**相关文件**:
- `packages/ui/src/components/ChatWindow.vue` (第710-723行)
- `packages/web/src/AppContent.vue` (第375-437行)

**问题分析**:
```typescript
// ChatWindow.vue 中的发送逻辑
const handleSend = () => {
  if (inputText.value.trim()) {
    const text = inputText.value.trim();
    if (chatMode.value === 'free') {
      // 自由聊天模式
      emit('freeChat', text);
    } else {
      // Agent模式
      emit('send', text, forcedAgent.value);
    }
    inputText.value = '';
  }
};
```

**问题根源**: 
在`AppContent.vue`的`handleFreeChat`方法中，仍然会创建带有`agentType: 'CONDUCTOR'`的消息，导致系统认为这是Agent模式。

**修复建议**:
1. 修改`handleFreeChat`方法，不设置agentType
2. 确保自由聊天模式直接调用LLM，不经过路由系统
3. 在UI上明确区分两种模式的状态

### 3. 聊天记录删除功能不完整

**问题描述**: 
- 无法单独删除单个聊天记录
- 多选删除后刷新页面会重新出现已删除的记录
- 删除所有记录后会新增一个空记录

**影响范围**: 数据管理功能异常

**相关文件**:
- `packages/ui/src/components/ChatSidebar.vue` (第220-244行)
- `packages/ui/src/composables/useChatHistory.ts` (第116-133行)

**问题分析**:
```typescript
// ChatSidebar.vue 中的删除逻辑
const handleDeleteSelected = () => {
  try {
    const deletedCount = selectedSessions.value.length;
    
    // 逐个删除选中的会话
    selectedSessions.value.forEach(sessionId => {
      deleteSession(sessionId);
    });
    
    selectedSessions.value = [];
    isSelectMode.value = false;
    
    message.success(`已删除 ${deletedCount} 个聊天记录`);
    showBatchActionsDialog.value = false;
  } catch (error) {
    console.error('删除失败:', error);
    message.error('删除失败，请重试');
  }
};
```

**问题根源**:
1. `deleteSession`方法在删除当前会话时可能触发自动创建新会话
2. 本地存储的同步问题
3. 会话状态管理不一致

**修复建议**:
1. 修复`useChatHistory.ts`中的删除逻辑
2. 确保删除后不会自动创建新会话
3. 改进本地存储的同步机制

## 中优先级问题

### 4. 流式输出响应式更新问题

**问题描述**: 流式输出时，内容更新可能不及时或出现卡顿。

**相关文件**:
- `packages/web/src/AppContent.vue` (第250-256行)

**问题分析**:
```typescript
// 强制触发响应式更新
const messageIndex = chatStore.messages.value.findIndex(m => m.id === streamingMsg.id);
if (messageIndex !== -1) {
  chatStore.messages.value = [...chatStore.messages.value];
}
```

**修复建议**:
1. 使用Vue的响应式系统而不是强制更新
2. 优化流式更新的性能
3. 添加防抖机制避免过于频繁的更新

### 5. 自定义Agent注册问题

**问题描述**: 自定义Agent的注册和路由可能存在时序问题。

**相关文件**:
- `packages/core/src/services/router/service.ts` (第50-62行)
- `packages/web/src/AppContent.vue` (第112-138行)

**问题分析**:
```typescript
// RouterService中的注册逻辑
registerCustomAgent(config: CustomAgentConfig) {
  const agentType = `CUSTOM_${config.id}` as AgentType;
  const customAgent = new CustomAgent(config, this.llmService);
  this.agents.set(agentType, customAgent);
}
```

**修复建议**:
1. 确保Agent注册的时序正确
2. 添加注册状态的验证
3. 改进错误处理机制

## 低优先级问题

### 6. 错误处理不够完善

**问题描述**: 部分错误没有友好的用户提示。

**修复建议**:
1. 统一错误处理机制
2. 添加更详细的错误信息
3. 提供错误恢复建议

### 7. 性能优化空间

**问题描述**: 大量消息时可能存在性能问题。

**修复建议**:
1. 实现虚拟滚动
2. 优化消息渲染
3. 添加分页加载

### 8. 逆向工程师功能不完整

**问题描述**: X0逆向工程师无法直接输出用户输入提示词的生成者工程师的完整提示词，只能进行结构分析。

**影响范围**: 核心功能缺失

**相关文件**:
- `agent_matrix/X0_reverse/reverse_engineer.md` (第88-191行)

**问题分析**:
当前逆向工程师只能分析提示词的结构和设计思路，但无法输出完整的生成者工程师提示词，这限制了用户对提示词来源的完整理解。

**修复建议**:
1. 在逆向分析报告中增加"生成者工程师提示词"输出
2. 基于分析结果重构完整的工程师提示词
3. 提供可复用的工程师角色设计
4. 增加工程师类型特征模板输出

**代码位置**:
- 需要更新`reverse_engineer.md`的OutputFormat部分
- 增加工程师角色重构功能
- 添加工程师类型特征模板

### 9. agent_matrix sources文件未被路由使用

**问题描述**: agent_matrix中sources文件夹的角色提示词没有被QA过程路由到，系统使用的是硬编码的默认提示词。

**影响范围**: 核心功能失效

**相关文件**:
- `packages/core/src/utils/agent-loader.ts` (第260-262行)
- `agent_matrix/X0_optimizer/sources/提示词迭代优化工程师.md`
- `agent_matrix/X1_basic/sources/agent专用提示词工程师_性能强化250930.md`
- `agent_matrix/X4_scenario/sources/3.带建议优化角色_最优选_高智能模型_性能强化250930.md`

**问题分析**:
```typescript
// agent-loader.ts 第260-262行
export const agentLoader = new AgentLoader(
  undefined // 禁用文件系统，始终使用默认提示词
);
```

当前系统配置为禁用文件系统访问，所有Agent都使用`DEFAULT_PROMPTS`中的硬编码内容，而`agent_matrix/sources/`文件夹中的实际提示词文件被忽略。

**修复建议**:
1. 启用文件系统访问，修改AgentLoader配置
2. 添加环境变量控制文件系统使用
3. 实现热重载机制，支持sources文件更新
4. 添加文件监听，自动重新加载更新的提示词
5. （重要）增加用户自由选择的功能，让用户可以在Xi层级选择任意source的工程师角色来完成对话

**代码位置**:
- 需要修改`agent-loader.ts`的构造函数参数
- 需要更新Agent加载逻辑，支持文件系统访问
- 需要添加文件监听和热重载机制

### 10. 默认工程师角色编辑功能缺失

**问题描述**: 系统自带的默认工程师角色（X0、X1、X4等）的编辑按钮是假的，点击后显示"功能开发中敬请期待"，无法进行实际编辑。

**影响范围**: 用户体验严重受影响

**相关文件**:
- `packages/ui/src/components/AgentSelector.vue` (编辑按钮相关代码)
- `packages/web/src/AppContent.vue` (Agent管理相关逻辑)

**问题分析**:
当前系统只支持自定义Agent的创建和编辑，但不支持对系统内置的默认工程师角色进行编辑。用户无法通过WebUI修改X0、X1、X4等默认角色的提示词内容。

**修复建议**:
1. 实现默认工程师角色的编辑功能
2. 添加角色编辑对话框，支持修改系统提示词
3. 实现角色保存和重置功能
4. 添加角色版本管理，支持回滚到原始版本

**代码位置**:
- 需要实现Agent编辑对话框组件
- 需要添加默认角色的编辑逻辑
- 需要实现角色配置的持久化存储

## 技术债务

### 11. 代码结构优化

**问题描述**: 部分组件职责不够清晰，存在耦合。

**修复建议**:
1. 重构组件结构
2. 提取公共逻辑
3. 改进类型定义

### 12. 测试覆盖不足

**问题描述**: 缺少单元测试和集成测试。

**修复建议**:
1. 添加组件测试
2. 添加服务层测试
3. 添加E2E测试

## 修复优先级建议

1. **立即修复**: 问题1、2、3（影响核心功能）
2. **近期修复**: 问题4、5、8、9、10（影响用户体验和核心功能）
3. **后续优化**: 问题6、7、11、12（技术债务）

## 修复计划

### 第一阶段（核心功能修复）
- [ ] 添加流式输出停止按钮
- [ ] 修复测试模式功能
- [ ] 完善聊天记录删除功能

### 第二阶段（体验优化）
- [ ] 优化流式输出响应式更新
- [ ] 修复自定义Agent注册问题
- [ ] 完善错误处理
- [ ] 增强逆向工程师功能（输出生成者工程师提示词）
- [ ] 启用agent_matrix sources文件路由功能
- [ ] 实现默认工程师角色编辑功能

### 第三阶段（技术债务）
- [ ] 代码结构重构
- [ ] 性能优化
- [ ] 测试覆盖

## 注意事项

1. **向后兼容**: 修复时需要考虑现有数据的兼容性
2. **用户体验**: 修复过程中要确保用户体验的连续性
3. **测试验证**: 每个修复都需要充分的测试验证
4. **文档更新**: 修复后需要更新相关文档

## 联系信息

如有问题或需要进一步说明，请联系开发团队。

---

**文档生成时间**: 2025-10-05  
**最后更新**: 2025-10-05  
**版本**: 0.1.0
